<html>
	<body>
		<script type="text/javascript">
			var Gamepad = {
			  data:
			  {
			    joystick: 
			    {
			      0: {
			        X: null,
			        Y: null,
			      },
			      1: {
			        X: null,
			        Y: null,
			      },
			    },
			  }
			};

			Gamepad.init = function()
			{
			  // As of writing, it seems impossible to detect Gamepad API support
			  // in Firefox, hence we need to hardcode it in the third clause. 
			  // (The preceding two clauses are for Chrome.)
			  var gamepadSupportAvailable = !!navigator.webkitGetGamepads || !!navigator.webkitGamepads;

			  if(!gamepadSupportAvailable) 
			  {
			    return false;
			  }
			  else
			  {
			    window.setInterval(this.update,100);
			    return true;
			  }
			}

			Gamepad.update = function()
			{
			  var gamepad = navigator.webkitGetGamepads()[0];

			  Gamepad.data.joystick[0].X = gamepad.axes[0];
			  Gamepad.data.joystick[0].Y = gamepad.axes[1];
			  Gamepad.data.joystick[1].X = gamepad.axes[2];
			  Gamepad.data.joystick[1].Y = gamepad.axes[3];

			  Gamepad.ondata(Gamepad.data);
			}

			Gamepad.ondata = function(data){};
		
			window.onload = function()
			{
				var ws = new WebSocket("ws://" + location.host,"earthrover");
			
				ws.onopen = function()	
				{
					console.log("Connection Opened");

					if(!Gamepad.init())
					{
						alert("Xbox Controller not Supported");
						console.log("Xbox Controller not Supported");
						return;
					}
				}

				ws.onmessage = function(message)
				{
					console.log(message);
					message = JSON.parse(message);
					console.log(message);
				}

				Gamepad.ondata = function(data)
				{
//					console.log("Sending joystick data: " + data.joystick[0].X + ":" + data.joystick[0].Y + ":" + data.joystick[1].X + ":" + data.joystick[1].Y);
					ws.send(data.joystick[0].X + ":" + data.joystick[0].Y + ":" + data.joystick[1].X + ":" + data.joystick[1].Y);
				}
			}
		</script>
	</body>
</html>
